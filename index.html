<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <title>FundedNext Calendar Tracker</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <style>
        body {
            background: #f8f9fa;
        }

        .calendar {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 4px;
        }

        .day {
            background: white;
            border: 1px solid #ddd;
            min-height: 100px;
            padding: 4px;
            cursor: pointer;
            position: relative;
            display: flex;
            flex-direction: column;
        }

        .day.disabled {
            background: #e9ecef;
            color: #6c757d;
            cursor: not-allowed;
        }

        .day-number {
            font-weight: bold;
            font-size: 14px;
            margin-bottom: 4px;
        }

        .day-entry {
            font-size: 12px;
            margin-top: auto;
        }

        .today {
            border: 2px solid #0d6efd;
        }

        .profit-entry {
            color: green;
        }

        .payout-entry {
            color: red;
        }
    </style>
</head>

<body>
    <div class="container py-4">
        <h2 class="mb-3 text-center">üìä FundedNext Calendar Tracker</h2>

        <!-- Summary -->
        <div class="card mb-3">
            <div class="card-body d-flex justify-content-between align-items-center flex-wrap">
                <div>
                    <p><strong>Gross Profit: </strong>$<span id="grossProfit">0.00</span></p>
                    <p><strong>Net Profit: </strong>$<span id="netProfit">0.00</span></p>
                    <p><strong>Highest Day Profit:</strong> $<span id="highestProfit">0</span></p>
                    <p><strong>Consistency:</strong> <span id="consistency">0%</span></p>
                    <p><strong>Status:</strong> <span id="status" class="fw-bold text-danger">‚ùå Not Eligible</span></p>
                </div>
                <div class="d-flex flex-column gap-2">
                    <button id="payoutBtn" class="btn btn-primary">üíµ Payout</button>
                    <button id="resetBtn" class="btn btn-danger">‚ôªÔ∏è Reset</button>
                    <button id="loginBtn" class="btn btn-success">üîë Login with Google</button>
                    <button id="syncBtn" class="btn btn-info d-none">‚òÅÔ∏è Sync with Drive</button>

                </div>
            </div>
        </div>

        <!-- Calendar Header -->
        <div class="d-flex justify-content-between align-items-center mb-2">
            <button id="prevMonth" class="btn btn-outline-secondary">&lt;</button>
            <h4 id="monthYear"></h4>
            <button id="nextMonth" class="btn btn-outline-secondary">&gt;</button>
        </div>

        <!-- Calendar -->
        <div class="calendar border rounded p-2 bg-white" id="calendar"></div>
    </div>

    <script>
        let profits = JSON.parse(localStorage.getItem("profits")) || [];
        let currentDate = new Date();

        function buildCalendar(date) {
            $("#calendar").empty();
            const year = date.getFullYear();
            const month = date.getMonth();

            // Update header
            const monthName = date.toLocaleString("default", { month: "long" });
            $("#monthYear").text(`${monthName} ${year}`);

            // First day of the month
            const firstDay = new Date(year, month, 1).getDay();
            const daysInMonth = new Date(year, month + 1, 0).getDate();

            // Fill blanks
            for (let i = 0; i < firstDay; i++) {
                $("#calendar").append(`<div class="day disabled"></div>`);
            }

            // Days
            for (let d = 1; d <= daysInMonth; d++) {
                let dayDate = new Date(year, month, d);
                let isoDate = `${year}-${String(month + 1).padStart(2, "0")}-${String(d).padStart(2, "0")}`;

                let isWeekend = dayDate.getDay() === 0 || dayDate.getDay() === 6;
                let entries = profits.filter(p => p.date === isoDate);

                let cell = $(`<div class="day ${isWeekend ? "disabled" : ""}"></div>`);
                let today = new Date();
                let todayStr = `${today.getFullYear()}-${String(today.getMonth() + 1).padStart(2, "0")}-${String(today.getDate()).padStart(2, "0")}`;

                if (isoDate === todayStr) {
                    cell.addClass("today");
                }

                cell.append(`<div class="day-number">${d}</div>`);

                if (entries.length > 0) {
                    entries.forEach(entry => {
                        let label = entry.type === "payout" ? "üü• Payout" : "üü© Profit";
                        let cssClass = entry.type === "payout" ? "payout-entry" : "profit-entry";
                        cell.append(`
            <div class="day-entry ${cssClass}">
              ${label}: $${entry.profit}<br>
              <small>${entry.journal || ""}</small>
            </div>
          `);
                    });
                }

                if (!isWeekend) {
                    cell.click(() => openEntryModal(isoDate));
                }
                $("#calendar").append(cell);
            }

            updateSummary();
        }

        function openEntryModal(date) {
            let existingProfit = profits.find(p => p.date === date && p.type === "profit");

            Swal.fire({
                title: `Add/Update Profit (${date})`,
                html: `
        <input type="number" id="profitInput" class="swal2-input" placeholder="Profit ($)" 
               value="${existingProfit ? existingProfit.profit : ""}">
        <textarea id="journalInput" class="swal2-textarea" placeholder="Journal Lesson">${existingProfit ? existingProfit.journal : ""}</textarea>
      `,
                confirmButtonText: 'Save',
                showCancelButton: true,
                preConfirm: () => {
                    const profit = parseFloat(document.getElementById("profitInput").value);
                    const journal = document.getElementById("journalInput").value.trim();
                    if (isNaN(profit) || profit <= 0) {
                        Swal.showValidationMessage("Please enter a valid profit");
                        return false;
                    }
                    return { profit, journal };
                }
            }).then(result => {
                if (result.isConfirmed) {
                    if (existingProfit) {
                        // Update existing profit
                        existingProfit.profit = result.value.profit;
                        existingProfit.journal = result.value.journal;
                    } else {
                        // Add new profit
                        profits.push({ date, profit: result.value.profit, journal: result.value.journal, type: "profit" });
                    }
                    localStorage.setItem("profits", JSON.stringify(profits));
                    buildCalendar(currentDate);
                }
            });
        }
function getCurrentCycleProfits() {
    // Find last payout date
    let lastPayoutIndex = profits.map(p => p.type).lastIndexOf("payout");
    if (lastPayoutIndex === -1) {
        // No payout yet ‚Üí return all profits
        return profits.filter(p => p.type === "profit");
    } else {
        // Only profits after last payout
        let lastPayoutDate = new Date(profits[lastPayoutIndex].date);
        return profits.filter(p => p.type === "profit" && new Date(p.date) > lastPayoutDate);
    }
}

function getHighestProfitEver() {
    // Only count positive profits (ignore payouts)
    let profitDays = profits.filter(p => p.type === "profit").map(p => p.profit);
    return profitDays.length > 0 ? Math.max(...profitDays) : 0;
}

function updateSummary() {
    let grossProfit = 0, netProfit = 0;
    let highestEver = getHighestProfitEver();

    // Net profit = all profits - payouts
    profits.forEach(p => netProfit += p.profit);

    // Only profits after last payout = current cycle
    let cycleProfits = getCurrentCycleProfits();
    cycleProfits.forEach(p => grossProfit += p.profit);

    // Consistency uses highestEver √∑ grossProfit (not current cycle‚Äôs max!)
    let consistency = grossProfit > 0 ? (highestEver / grossProfit) * 100 : 0;
    let eligible = consistency <= 40 && grossProfit >= 250;

    $("#grossProfit").text(grossProfit.toFixed(2));
    $("#netProfit").text(netProfit.toFixed(2));
    $("#highestProfit").text(highestEver.toFixed(2));
    $("#consistency").text(consistency.toFixed(2) + "%");
    $("#status")
        .text(eligible ? "‚úÖ Eligible" : "‚ùå Not Eligible")
        .removeClass("text-danger text-success")
        .addClass(eligible ? "text-success" : "text-danger");
}

$("#payoutBtn").click(function () {
    let cycleProfits = getCurrentCycleProfits();
    let total = cycleProfits.reduce((a, b) => a + b.profit, 0);
    let highestEver = getHighestProfitEver();
    let consistency = total > 0 ? (highestEver / total) * 100 : 0;
    let eligible = consistency <= 40 && total >= 250;

    if (!eligible) {
        Swal.fire(
            "Not Eligible",
            "You must meet consistency ‚â§ 40% and have at least $250 profit in this cycle before payout.",
            "error"
        );
        return;
    }

    Swal.fire({
        title: "Request Payout",
        html: `
            <input type="number" id="payoutAmount" class="swal2-input" placeholder="Enter payout amount ($)">
            <input type="date" id="payoutDate" class="swal2-input">
        `,
        showCancelButton: true,
        confirmButtonText: "Withdraw",
        preConfirm: () => {
            const payout = parseFloat(document.getElementById("payoutAmount").value);
            const payoutDate = document.getElementById("payoutDate").value;

            if (isNaN(payout) || payout <= 0 || payout > total) {
                Swal.showValidationMessage("Invalid payout amount");
                return false;
            }
            if (!payoutDate) {
                Swal.showValidationMessage("Please select a payout date");
                return false;
            }
            return { payout, payoutDate };
        }
    }).then(result => {
        if (result.isConfirmed) {
            const { payout, payoutDate } = result.value;

            profits.push({
                date: payoutDate,
                profit: -payout,
                journal: "Payout",
                type: "payout"
            });

            localStorage.setItem("profits", JSON.stringify(profits));
            Swal.fire("Success", `Payout of $${payout} recorded on ${payoutDate}.`, "success");
            buildCalendar(currentDate);
        }
    });
});


        $("#resetBtn").click(function () {
            Swal.fire({
                title: "Reset All Data?",
                text: "This will permanently delete all profits and journals.",
                icon: "warning",
                showCancelButton: true,
                confirmButtonText: "Yes, reset it!"
            }).then(res => {
                if (res.isConfirmed) {
                    profits = [];
                    localStorage.removeItem("profits");
                    buildCalendar(currentDate);
                    Swal.fire("Reset", "All data has been cleared.", "success");
                }
            });
        });

        // Navigation
        $("#prevMonth").click(() => {
            currentDate.setMonth(currentDate.getMonth() - 1);
            buildCalendar(currentDate);
        });
        $("#nextMonth").click(() => {
            currentDate.setMonth(currentDate.getMonth() + 1);
            buildCalendar(currentDate);
        });

        // Init
        buildCalendar(currentDate);


        const CLIENT_ID = "7512773874-3bjonen8egmktdtpcjb7gthnrpd0seea.apps.googleusercontent.com";
const REDIRECT_URI = window.location.origin + window.location.pathname;
const SCOPES = "https://www.googleapis.com/auth/drive.file";

let accessToken = null;

// Step 1: PKCE helpers
function base64urlencode(a) {
  return btoa(String.fromCharCode.apply(null, new Uint8Array(a)))
    .replace(/\+/g, "-").replace(/\//g, "_").replace(/=+$/, "");
}
async function sha256(buffer) {
  return crypto.subtle.digest("SHA-256", buffer);
}
function randomString(len=43) {
  const chars = "ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789-._~";
  let result = "";
  for (let i=0; i<len; i++) result += chars.charAt(Math.floor(Math.random()*chars.length));
  return result;
}

// Step 2: Login
async function login() {
  const codeVerifier = randomString(64);
  const codeChallenge = base64urlencode(await sha256(new TextEncoder().encode(codeVerifier)));
  localStorage.setItem("code_verifier", codeVerifier);

  const authUrl = `https://accounts.google.com/o/oauth2/v2/auth?response_type=code&client_id=${CLIENT_ID}&redirect_uri=${encodeURIComponent(REDIRECT_URI)}&scope=${encodeURIComponent(SCOPES)}&code_challenge=${codeChallenge}&code_challenge_method=S256&access_type=offline`;

  window.location.href = authUrl;
}

// Step 3: Exchange code for token
async function handleRedirect() {
  const params = new URLSearchParams(window.location.search);
  if (params.has("code")) {
    const code = params.get("code");
    const codeVerifier = localStorage.getItem("code_verifier");

    const resp = await fetch("https://oauth2.googleapis.com/token", {
      method: "POST",
      headers: {"Content-Type": "application/x-www-form-urlencoded"},
      body: new URLSearchParams({
        client_id: CLIENT_ID,
        grant_type: "authorization_code",
        code,
        code_verifier: codeVerifier,
        redirect_uri: REDIRECT_URI
      })
    });
    const data = await resp.json();
    accessToken = data.access_token;
    history.replaceState({}, document.title, REDIRECT_URI); // remove ?code= param
    $("#loginBtn").addClass("d-none");
    $("#syncBtn").removeClass("d-none");
    loadFromDrive();
  }
}

// Step 4: Sync to Drive
async function saveToDrive() {
  if (!accessToken) return alert("Not logged in!");
  const fileContent = JSON.stringify(profits);
  const metadata = { name: "fundednext_profits.json", mimeType: "application/json" };

  // Search if file already exists
  let searchResp = await fetch("https://www.googleapis.com/drive/v3/files?q=name='fundednext_profits.json' and trashed=false", {
    headers: {Authorization: `Bearer ${accessToken}`}
  });
  let searchData = await searchResp.json();

  let fileId = searchData.files && searchData.files.length > 0 ? searchData.files[0].id : null;

  const form = new FormData();
  form.append("metadata", new Blob([JSON.stringify(metadata)], { type: "application/json" }));
  form.append("file", new Blob([fileContent], { type: "application/json" }));

  let url = fileId
    ? `https://www.googleapis.com/upload/drive/v3/files/${fileId}?uploadType=multipart`
    : "https://www.googleapis.com/upload/drive/v3/files?uploadType=multipart";

  const res = await fetch(url, {
    method: fileId ? "PATCH" : "POST",
    headers: { Authorization: `Bearer ${accessToken}` },
    body: form
  });

  if (res.ok) Swal.fire("‚úÖ Synced!", "Your data is now backed up to Google Drive.", "success");
}

// Step 5: Load from Drive
async function loadFromDrive() {
  const searchResp = await fetch("https://www.googleapis.com/drive/v3/files?q=name='fundednext_profits.json' and trashed=false", {
    headers: {Authorization: `Bearer ${accessToken}`}
  });
  const searchData = await searchResp.json();
  if (searchData.files && searchData.files.length > 0) {
    const fileId = searchData.files[0].id;
    const fileResp = await fetch(`https://www.googleapis.com/drive/v3/files/${fileId}?alt=media`, {
      headers: {Authorization: `Bearer ${accessToken}`}
    });
    const json = await fileResp.json();
    profits = json;
    localStorage.setItem("profits", JSON.stringify(profits));
    buildCalendar(currentDate);
    Swal.fire("‚òÅÔ∏è Restored", "Data loaded from Google Drive!", "info");
  }
}

$("#loginBtn").on("click", login);
$("#syncBtn").on("click", saveToDrive);

handleRedirect();

    </script>
</body>

</html>
